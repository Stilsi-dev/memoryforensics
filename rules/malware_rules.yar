/*
Memory-oriented YARA rules.
Notes:
- Uses wide+ascii for better Windows RAM coverage
- Avoids ultra-generic PE-only conditions that match most processes
- Adds meta confidence tiers so the Python tool can treat rules differently
*/

rule Mimikatz_Indicators {
    meta:
        id = "MF-G2-001"
        description = "Detects indicators of Mimikatz credential dumping tool"
        author = "MemoryForensics Group 2"
        confidence = "high"
        tags = "credential, mimikatz"
    strings:
        $m1 = "mimikatz" nocase wide ascii
        $m2 = "sekurlsa::logonpasswords" nocase wide ascii
        $m3 = "kerberos::ptt" nocase wide ascii
        $m4 = "privilege::debug" nocase wide ascii
    condition:
        any of them
}

rule CobaltStrike_Beacon {
    meta:
        id = "MF-G2-002"
        description = "Detects Cobalt Strike beacon indicators"
        author = "MemoryForensics Group 2"
        confidence = "high"
        tags = "cobalt, c2"
    strings:
        $cs1 = "beacon.dll" nocase wide ascii
        $cs2 = "beacon.x64.dll" nocase wide ascii
        $cs3 = "ReflectiveLoader" nocase wide ascii
        $cs4 = "postex.dll" nocase wide ascii
    condition:
        any of them
}

rule PowerShell_Exploitation {
    meta:
        id = "MF-G2-003"
        description = "Detects common PowerShell exploitation patterns"
        author = "MemoryForensics Group 2"
        confidence = "medium"
        tags = "exploit, powershell, lolbins"
    strings:
        $ps1 = "-nop" nocase wide ascii
        $ps2 = "-executionpolicy" nocase wide ascii
        $ps3 = "bypass" nocase wide ascii
        $ps4 = "-encodedcommand" nocase wide ascii
        $ps5 = "IEX" nocase wide ascii
        $ps6 = "DownloadString" nocase wide ascii
        $ps7 = "System.Management.Automation" nocase wide ascii
        $ps8 = "FromBase64String" nocase wide ascii
    condition:
        3 of ($ps*)
}

rule Process_Injection {
    meta:
        id = "MF-G2-004"
        description = "Detects common process injection API indicators (low confidence alone)"
        author = "MemoryForensics Group 2"
        confidence = "low"
        tags = "injection, evasion"
    strings:
        $pi1 = "CreateRemoteThread" nocase wide ascii
        $pi2 = "WriteProcessMemory" nocase wide ascii
        $pi3 = "VirtualAllocEx" nocase wide ascii
        $pi4 = "NtMapViewOfSection" nocase wide ascii
        $pi5 = "QueueUserAPC" nocase wide ascii
        $context = "injection" nocase wide ascii
    condition:
        (all of ($pi1, $pi2, $pi3) and $context) or (all of ($pi4, $pi5) and $context)
}

rule Ransomware_Indicators {
    meta:
        id = "MF-G2-005"
        description = "Detects common ransomware-related strings"
        author = "MemoryForensics Group 2"
        confidence = "medium"
        tags = "ransomware"
    strings:
        $r1 = "Your files have been encrypted" nocase wide ascii
        $r2 = "recover your files" nocase wide ascii
        $r3 = "bitcoin" nocase wide ascii
        $r4 = "payment" nocase wide ascii
        $r5 = ".locked" nocase wide ascii
        $r6 = ".encrypted" nocase wide ascii
    condition:
        ($r1 or $r2) and ($r3 or $r4) or 2 of ($r5, $r6)
}

rule Credential_Dumping_Tools {
    meta:
        id = "MF-G2-007"
        description = "Detects common credential dumping related artifacts"
        author = "MemoryForensics Group 2"
        confidence = "medium"
        tags = "credential, dumping"
    strings:
        $cd1 = "lsass.dmp" nocase wide ascii
        $cd2 = "procdump" nocase wide ascii
        $cd3 = "comsvcs.dll" nocase wide ascii
        $cd4 = "ntds.dit" nocase wide ascii
        $cd5 = "MiniDumpWriteDump" nocase wide ascii
    condition:
        ($cd1 and ($cd2 or $cd5)) or ($cd3 and $cd5) or ($cd4)
}

rule Web_Shell_Indicators {
    meta:
        id = "MF-G2-009"
        description = "Detects basic web shell command execution strings"
        author = "MemoryForensics Group 2"
        confidence = "low"
        tags = "webshell"
    strings:
        $ws1 = "cmd.exe /c" nocase wide ascii
        $ws2 = "powershell.exe -" nocase wide ascii
        $ws3 = "whoami" nocase wide ascii
        $ws4 = "w3wp.exe" nocase wide ascii
        $ws5 = "aspx" nocase wide ascii
    condition:
        all of them or ($ws4 and 2 of ($ws1, $ws2, $ws3))
}

rule RemoteAccessTool_Strings {
    meta:
        id = "MF-G2-011"
        description = "Detects common RAT family strings"
        author = "MemoryForensics Group 2"
        confidence = "medium"
        tags = "rat, backdoor"
    strings:
        $rat1 = "NanoCore" nocase wide ascii
        $rat2 = "AsyncRAT" nocase wide ascii
        $rat3 = "njRAT" nocase wide ascii
    condition:
        any of them
}
// v3.3 Enhanced APT Families and Banking Trojans

rule APT_Lazarus_Indicators {
    meta:
        id = "MF-G2-012"
        description = "Detects indicators of Lazarus Group campaigns (v3.3)"
        author = "MemoryForensics Group 2"
        confidence = "high"
        tags = "apt, lazarus, dprk"
    strings:
        $l1 = "WannaCry" nocase wide ascii
        $l2 = "Fallchill" nocase wide ascii
        $l3 = "Lazarus" nocase wide ascii
        $l4 = "operationBlockbuster" nocase wide ascii
    condition:
        any of them
}

rule APT_Turla_Indicators {
    meta:
        id = "MF-G2-013"
        description = "Detects indicators of Turla/Snake APT group (v3.3)"
        author = "MemoryForensics Group 2"
        confidence = "high"
        tags = "apt, turla, snake, russia"
    strings:
        $t1 = "Uroburos" nocase wide ascii
        $t2 = "Snake" nocase wide ascii
        $t3 = "Turla" nocase wide ascii
        $t4 = "Carbon" nocase wide ascii
        $t5 = "HiddenCobra" nocase wide ascii
    condition:
        any of them
}

rule APT_Carbanak_Indicators {
    meta:
        id = "MF-G2-014"
        description = "Detects Carbanak/FIN7 APT group indicators (v3.3)"
        author = "MemoryForensics Group 2"
        confidence = "high"
        tags = "apt, carbanak, fin7, financial"
    strings:
        $c1 = "Carbanak" nocase wide ascii
        $c2 = "FIN7" nocase wide ascii
        $c3 = "Deception" nocase wide ascii
        $c4 = "OSX_Emdivi" nocase wide ascii
    condition:
        any of them
}

rule ZeuS_Banking_Trojan {
    meta:
        id = "MF-G2-015"
        description = "Detects ZeuS banking trojan family indicators (v3.3)"
        author = "MemoryForensics Group 2"
        confidence = "high"
        tags = "banking, trojan, zeus, financial"
    strings:
        $z1 = "ZeuS" nocase wide ascii
        $z2 = "cfg.bin" nocase wide ascii
        $z3 = "bot.ini" nocase wide ascii
        $z4 = "Gameover" nocase wide ascii
        $z5 = "P2P" nocase wide ascii
    condition:
        2 of them
}

rule Emotet_Indicators {
    meta:
        id = "MF-G2-016"
        description = "Detects Emotet banking malware indicators (v3.3)"
        author = "MemoryForensics Group 2"
        confidence = "high"
        tags = "banking, emotet, trojan, worm"
    strings:
        $e1 = "Emotet" nocase wide ascii
        $e2 = "Heodo" nocase wide ascii
        $e3 = "/api/server.php" nocase wide ascii
        $e4 = "Feodo" nocase wide ascii
        $e5 = "C2" nocase wide ascii
    condition:
        2 of them
}

rule Dridex_Banking_Malware {
    meta:
        id = "MF-G2-017"
        description = "Detects Dridex banking malware indicators (v3.3)"
        author = "MemoryForensics Group 2"
        confidence = "high"
        tags = "banking, dridex, trojan, financial"
    strings:
        $d1 = "Dridex" nocase wide ascii
        $d2 = "Bugat" nocase wide ascii
        $d3 = "crypt_cfg" nocase wide ascii
        $d4 = "INJECT" nocase wide ascii
    condition:
        any of them
}

rule Cryptominer_XMR_Monero {
    meta:
        id = "MF-G2-018"
        description = "Detects Monero (XMR) cryptominer indicators (v3.3)"
        author = "MemoryForensics Group 2"
        confidence = "high"
        tags = "cryptominer, xmr, monero, performance"
    strings:
        $xmr1 = "monero" nocase wide ascii
        $xmr2 = "xmrig" nocase wide ascii
        $xmr3 = "stratum" nocase wide ascii
        $xmr4 = "cryptonight" nocase wide ascii
        $xmr5 = "mining_pool" nocase wide ascii
    condition:
        2 of them
}

rule Cryptominer_Bitcoin {
    meta:
        id = "MF-G2-019"
        description = "Detects Bitcoin mining malware indicators (v3.3)"
        author = "MemoryForensics Group 2"
        confidence = "high"
        tags = "cryptominer, bitcoin, gpu, performance"
    strings:
        $btc1 = "bitcoin" nocase wide ascii
        $btc2 = "mining" nocase wide ascii
        $btc3 = "pool.mining" nocase wide ascii
        $btc4 = "getblocktemplate" nocase wide ascii
        $btc5 = "stratum" nocase wide ascii
    condition:
        3 of them
}