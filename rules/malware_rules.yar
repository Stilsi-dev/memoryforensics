/*
Memory-oriented YARA rules.
Notes:
- Uses wide+ascii for better Windows RAM coverage
- Avoids ultra-generic PE-only conditions that match most processes
- Adds meta confidence tiers so the Python tool can treat rules differently
*/

rule Mimikatz_Indicators {
    meta:
        id = "MF-G2-001"
        description = "Detects indicators of Mimikatz credential dumping tool"
        author = "MemoryForensics Group 2"
        confidence = "high"
        tags = "credential, mimikatz"
    strings:
        $m1 = "mimikatz" nocase wide ascii
        $m2 = "sekurlsa::logonpasswords" nocase wide ascii
        $m3 = "kerberos::ptt" nocase wide ascii
        $m4 = "privilege::debug" nocase wide ascii
    condition:
        any of them
}

rule CobaltStrike_Beacon {
    meta:
        id = "MF-G2-002"
        description = "Detects Cobalt Strike beacon indicators"
        author = "MemoryForensics Group 2"
        confidence = "high"
        tags = "cobalt, c2"
    strings:
        $cs1 = "beacon.dll" nocase wide ascii
        $cs2 = "beacon.x64.dll" nocase wide ascii
        $cs3 = "ReflectiveLoader" nocase wide ascii
        $cs4 = "postex.dll" nocase wide ascii
    condition:
        any of them
}

rule PowerShell_Exploitation {
    meta:
        id = "MF-G2-003"
        description = "Detects common PowerShell exploitation patterns"
        author = "MemoryForensics Group 2"
        confidence = "medium"
        tags = "exploit, powershell, lolbins"
    strings:
        $ps1 = "-nop" nocase wide ascii
        $ps2 = "-executionpolicy" nocase wide ascii
        $ps3 = "bypass" nocase wide ascii
        $ps4 = "-encodedcommand" nocase wide ascii
        $ps5 = "IEX" nocase wide ascii
        $ps6 = "DownloadString" nocase wide ascii
        $ps7 = "System.Management.Automation" nocase wide ascii
        $ps8 = "FromBase64String" nocase wide ascii
    condition:
        3 of ($ps*)
}

rule Process_Injection {
    meta:
        id = "MF-G2-004"
        description = "Detects common process injection API indicators (low confidence alone)"
        author = "MemoryForensics Group 2"
        confidence = "low"
        tags = "injection, evasion"
    strings:
        $pi1 = "CreateRemoteThread" nocase wide ascii
        $pi2 = "WriteProcessMemory" nocase wide ascii
        $pi3 = "VirtualAllocEx" nocase wide ascii
        $pi4 = "NtMapViewOfSection" nocase wide ascii
        $pi5 = "QueueUserAPC" nocase wide ascii
        $context = "injection" nocase wide ascii
    condition:
        (all of ($pi1, $pi2, $pi3) and $context) or (all of ($pi4, $pi5) and $context)
}

rule Ransomware_Indicators {
    meta:
        id = "MF-G2-005"
        description = "Detects common ransomware-related strings"
        author = "MemoryForensics Group 2"
        confidence = "medium"
        tags = "ransomware"
    strings:
        $r1 = "Your files have been encrypted" nocase wide ascii
        $r2 = "recover your files" nocase wide ascii
        $r3 = "bitcoin" nocase wide ascii
        $r4 = "payment" nocase wide ascii
        $r5 = ".locked" nocase wide ascii
        $r6 = ".encrypted" nocase wide ascii
    condition:
        ($r1 or $r2) and ($r3 or $r4) or 2 of ($r5, $r6)
}

// DISABLED: Too many false positives - path strings appear in normal Windows processes
// Use DLL path checking in Python code instead
//rule Suspicious_Process_Paths {
//    meta:
//        id = "MF-G2-006"
//        description = "Detects suspicious Windows user-writable path strings found in memory"
//        author = "MemoryForensics Group 2"
//        confidence = "low"
//        tags = "evasion"
//    strings:
//        $sp1 = "\\temp\\" nocase wide ascii
//        $sp2 = "\\appdata\\" nocase wide ascii
//        $sp3 = "\\programdata\\" nocase wide ascii
//        $sp4 = "\\users\\public\\" nocase wide ascii
//    condition:
//        any of them
//}

rule Credential_Dumping_Tools {
    meta:
        id = "MF-G2-007"
        description = "Detects common credential dumping related artifacts"
        author = "MemoryForensics Group 2"
        confidence = "medium"
        tags = "credential, dumping"
    strings:
        $cd1 = "lsass.dmp" nocase wide ascii
        $cd2 = "procdump" nocase wide ascii
        $cd3 = "comsvcs.dll" nocase wide ascii
        $cd4 = "ntds.dit" nocase wide ascii
        $cd5 = "MiniDumpWriteDump" nocase wide ascii
    condition:
        ($cd1 and ($cd2 or $cd5)) or ($cd3 and $cd5) or ($cd4)
}

// DISABLED: Causes 100% false positive rate - these strings are extremely common
// Re-enable only for targeted Office process memory analysis
//rule Malicious_Office_Macros {
//    meta:
//        id = "MF-G2-008"
//        description = "Detects Office macro abuse indicators (low confidence)"
//        author = "MemoryForensics Group 2"
//        confidence = "low"
//        tags = "office, macro"
//    strings:
//        $mo1 = "WScript.Shell" nocase wide ascii
//        $mo2 = "CreateObject(" nocase wide ascii
//        $mo3 = "AutoOpen" nocase wide ascii
//        $mo4 = "Document_Open" nocase wide ascii
//    condition:
//        2 of them
//}

rule Web_Shell_Indicators {
    meta:
        id = "MF-G2-009"
        description = "Detects basic web shell command execution strings"
        author = "MemoryForensics Group 2"
        confidence = "low"
        tags = "webshell"
    strings:
        $ws1 = "cmd.exe /c" nocase wide ascii
        $ws2 = "powershell.exe -" nocase wide ascii
        $ws3 = "whoami" nocase wide ascii
        $ws4 = "w3wp.exe" nocase wide ascii
        $ws5 = "aspx" nocase wide ascii
    condition:
        all of them or ($ws4 and 2 of ($ws1, $ws2, $ws3))
}

// DISABLED: This rule is informational only and better detected through PE analysis
// UPX string may appear in legitimate contexts
//rule Malware_Strings_Generic {
//    meta:
//        id = "MF-G2-010"
//        description = "Generic packer/PE hints (informational only in memory scanning)"
//        author = "MemoryForensics Group 2"
//        confidence = "low"
//        tags = "generic"
//    strings:
//        $g1 = "UPX!" wide ascii
//    condition:
//        $g1
//}

rule RemoteAccessTool_Strings {
    meta:
        id = "MF-G2-011"
        description = "Detects common RAT family strings"
        author = "MemoryForensics Group 2"
        confidence = "medium"
        tags = "rat, backdoor"
    strings:
        $rat1 = "NanoCore" nocase wide ascii
        $rat2 = "AsyncRAT" nocase wide ascii
        $rat3 = "njRAT" nocase wide ascii
    condition:
        any of them
}
