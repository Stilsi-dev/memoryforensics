<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Memory Forensics Dashboard</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="./styles.css" />
  <script src="https://d3js.org/d3.v7.min.js"></script>
</head>
<body>
  <div class="page">
    <header class="hero">
      <div>
        <p class="eyebrow">Phase 2 ¬∑ Enhanced</p>
        <h1>Memory Forensics Dashboard</h1>
        <p class="lede">Upload a memory dump, review threats, inspect processes, analyze timeline, and extract IOCs.</p>
      </div>
      <div class="status-pill" id="api-status">Checking API‚Ä¶</div>
    </header>

    <section class="panel">
      <div class="panel-header">
        <div>
          <p class="eyebrow">Upload</p>
          <h2>Submit a memory dump</h2>
          <p class="sub">Supports .mem, .raw, .bin. Files are analyzed for threats, IOCs, and timeline events.</p>
        </div>
      </div>
      <form id="upload-form" class="upload">
        <label for="file-input" class="file-input-label">
          <input type="file" id="file-input" name="file" accept=".mem,.raw,.bin" required />
          <span class="file-input-text">üìÅ Choose file</span>
          <span class="file-input-name" id="file-name"></span>
        </label>
        <input type="text" id="api-key-input" placeholder="API Key (optional)" style="flex: 0 0 200px; padding: 10px 12px; border: 1px solid var(--panel-border); border-radius: 8px; font-size: 0.95em; background: var(--panel); color: var(--text);" />
        <button type="submit">Upload</button>
        <span id="upload-msg" class="muted"></span>
      </form>
    </section>

    <section class="panel">
      <div class="panel-header">
        <div>
          <p class="eyebrow">Cases</p>
          <h2>Recent uploads</h2>
          <p class="sub">Select a case to view analysis, timeline, and IOCs.</p>
        </div>
        <button id="refresh-cases" class="ghost">Refresh</button>
      </div>
      <div id="cases-list" class="cases"></div>
    </section>

    <section class="grid" id="dashboard-section" style="display: none;">
      <div class="panel" id="dashboard-panel" style="grid-column: 1/-1;">
        <div class="panel-header dashboard-header">
          <div class="dashboard-title-block">
            <div class="dashboard-title-row">
              <p class="eyebrow">Analysis</p>
              <div id="caseStatus"></div>
            </div>
            <div class="dashboard-name-row">
              <h2 id="dashboard-title">Case Details</h2>
              <p class="sub" id="dashboard-meta"></p>
            </div>
          </div>
          <div class="dashboard-actions">
            <button id="refresh-case" class="ghost">Refresh now</button>
            <button id="close-case" class="ghost" onclick="closeDashboard()">Close</button>
          </div>
        </div>

        <div id="dashboardError" class="error" style="display: none;"></div>

        <!-- Summary Stats -->
        <div id="dashboard-stats" class="dashboard-stats" style="display: none;">
          <div class="stat-card">
            <div class="stat-label">Total Processes</div>
            <div class="stat-value" id="stat-process-count">0</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">Threat Level</div>
            <div class="stat-value threat-level" id="stat-threat-level">UNKNOWN</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">Suspicious Processes</div>
            <div class="stat-value" id="stat-suspicious-count">0</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">Network Connections</div>
            <div class="stat-value" id="stat-network-count">0</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">Risk Score</div>
            <div class="stat-value" id="stat-risk-score">0%</div>
          </div>
        </div>

        <!-- Tabs -->
        <div class="tabs">
          <button class="tab-button active" onclick="switchTab(event, 'threats')">üéØ Threats</button>
          <button class="tab-button" onclick="switchTab(event, 'processes')">üå≥ Processes</button>
          <button class="tab-button" onclick="switchTab(event, 'timeline')">üìä Timeline</button>
          <button class="tab-button" onclick="switchTab(event, 'iocs')">üîó IOCs</button>
        </div>

        <!-- Threats Tab -->
        <div id="threats" class="tab-content active">
          <div class="tab-controls">
            <label>
              <input type="checkbox" id="hide-low-threats" checked />
              <span>Hide low severity</span>
            </label>
          </div>
          <div id="threat-cards" class="threat-grid"></div>
        </div>

        <!-- Processes Tab (ASCII + D3.js) -->
        <div id="processes" class="tab-content">
          <div class="tab-controls">
            <input type="text" id="process-search" placeholder="Search processes..." class="search-box" />
          </div>
          <div id="processes-d3-container" style="display: none;"></div>
          <div id="tree" class="tree" style="display: block;"></div>
        </div>

        <!-- Timeline Tab -->
        <div id="timeline" class="tab-content">
          <div class="tab-controls">
            <label>
              <input type="checkbox" id="hide-low-timeline" />
              <span>Hide low severity</span>
            </label>
            <div class="timeline-sort-controls">
              <label for="timeline-sort-by" class="sort-label">Sort</label>
              <select id="timeline-sort-by" class="sort-select">
                <option value="timestamp">Time</option>
                <option value="risk">Risk score</option>
                <option value="severity">Severity</option>
              </select>
              <button id="timeline-sort-dir" class="sort-btn" type="button" data-dir="desc">Desc</button>
            </div>
          </div>
          <div id="timeline-d3-container" style="display: none;"></div>
          <div id="timeline-container" style="display: block;"></div>
        </div>

        <!-- IOCs Tab -->
        <div id="iocs" class="tab-content">
          <div class="tab-controls">
            <input type="text" id="ioc-search" placeholder="Search IOCs..." class="search-box" />
            <button class="export-btn" id="export-iocs-btn" onclick="exportIOCs()" style="display: none;">üì• Export IOCs</button>
          </div>
          <div id="network-graph-container" style="display: none;"></div>
          <div id="iocs-container"></div>
        </div>
      </div>
    </section>
  </div>

  <script defer src="./d3-visualizations.js"></script>
  <script defer src="./app.js"></script>

  <!-- Threat detail modal -->
  <div id="threat-modal" class="modal" aria-hidden="true">
    <div class="modal-backdrop" onclick="closeThreatModal()"></div>
    <div class="modal-dialog" role="dialog" aria-modal="true">
      <button class="modal-close" type="button" aria-label="Close" onclick="closeThreatModal()">√ó</button>
      <div class="modal-header">
        <div>
          <p class="eyebrow">Threat detail</p>
          <h3 id="threat-modal-title">Threat</h3>
        </div>
        <div class="modal-badges">
          <span id="threat-modal-severity" class="severity-pill">SEVERITY</span>
          <span id="threat-modal-score" class="score-chip">0%</span>
        </div>
      </div>
      <div id="threat-modal-body" class="modal-body"></div>
    </div>
  </div>
</body>
</html>
